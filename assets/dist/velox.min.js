// velox - v0.2.6 - https://github.com/jpillora/velox
// Jaime Pillora <dev@jpillora.com> - MIT Copyright 2016
!function(){!function(t){if(!("EventSource"in t)){var e=/^(\s|\u00A0)+|(\s|\u00A0)+$/g,n=function(t){function n(t){o._pollTimer=setTimeout(function(){i.call(o)},t)}function i(){try{if(o.readyState==o.CLOSED)return;var t=new XMLHttpRequest;t.open("GET",o.URL,!0),t.setRequestHeader("Accept","text/event-stream"),t.setRequestHeader("Cache-Control","no-cache"),t.setRequestHeader("X-Requested-With","XMLHttpRequest"),null!=a&&t.setRequestHeader("Last-Event-ID",a),h="",t.timeout=5e4,t.onreadystatechange=function(){if(3==this.readyState||4==this.readyState&&200==this.status){o.readyState==o.CONNECTING&&(o.readyState=o.OPEN,o.dispatchEvent("open",{type:"open"}));var t="";try{t=this.responseText||""}catch(i){}var c=t.substr(h.length).split("\n"),p="message",l=[],u=0,f="";for(h=t;u<c.length;u++)if(f=c[u].replace(e,""),0==f.indexOf("event"))p=f.replace(/event:?\s*/,"");else if(0==f.indexOf("retry"))retry=parseInt(f.replace(/retry:?\s*/,"")),isNaN(retry)||(s=retry);else if(0==f.indexOf("data"))l.push(f.replace(/data:?\s*/,""));else if(0==f.indexOf("id:"))a=f.replace(/id:?\s*/,"");else if(0==f.indexOf("id"))a=null;else if(""==f&&l.length){var d=new r(l.join("\n"),o.url,a);o.dispatchEvent(p,d),l=[],p="message"}4==this.readyState&&n(s)}else o.readyState!==o.CLOSED&&(4==this.readyState?(o.readyState=o.CONNECTING,o.dispatchEvent("error",{type:"error"}),n(s)):0==this.readyState&&n(s))},t.send(),setTimeout(function(){t.abort()},t.timeout),o._xhr=t}catch(i){o.dispatchEvent("error",{type:"error",data:i.message})}}var o=this,s=500,a=null,h="";if(!t||"string"!=typeof t)throw new SyntaxError("Not enough arguments");this.URL=t,this.readyState=this.CONNECTING,this._pollTimer=null,this._xhr=null,i()};n.prototype={close:function(){this.readyState=this.CLOSED,clearInterval(this._pollTimer),this._xhr.abort()},CONNECTING:0,OPEN:1,CLOSED:2,dispatchEvent:function(t,e){var n=this["_"+t+"Handlers"];if(n)for(var r=0;r<n.length;r++)n[r].call(this,e);this["on"+t]&&this["on"+t].call(this,e)},addEventListener:function(t,e){this["_"+t+"Handlers"]||(this["_"+t+"Handlers"]=[]),this["_"+t+"Handlers"].push(e)},removeEventListener:function(t,e){var n=this["_"+t+"Handlers"];if(n)for(var r=n.length-1;r>=0;--r)if(n[r]===e){n.splice(r,1);break}},onerror:null,onmessage:null,onopen:null,readyState:0,URL:""};var r=function(t,e,n){this.data=t,this.origin=e,this.lastEventId=n||""};r.prototype={data:null,type:"message",lastEventId:"",origin:""},"module"in t&&(module.exports=n),t.EventSource=n}}(this);var t,e=this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);n.prototype=e.prototype,t.prototype=new n},n=Error;!function(t){function r(t,e){switch(typeof t){case"undefined":case"boolean":case"string":case"number":return t===e;case"object":if(null===t)return null===e;if(c(t)){if(!c(e)||t.length!==e.length)return!1;for(var n=0,i=t.length;i>n;n++)if(!r(t[n],e[n]))return!1;return!0}var o=p(e),s=o.length;if(p(t).length!==s)return!1;for(var n=0;s>n;n++)if(!r(t[n],e[n]))return!1;return!0;default:return!1}}function i(t){for(var e,n=0,r=t.length;r>n;){e=t.charCodeAt(n);{if(!(e>=48&&57>=e))return!1;n++}}return!0}function o(t,e,n){for(var r,o,s=!1,a=0,h=e.length;h>a;){r=e[a],a++;for(var p=r.path||"",v=p.split("/"),y=t,E=1,g=v.length,O=void 0;;){if(o=v[E],n&&void 0===O&&(void 0===y[o]?O=v.slice(0,E).join("/"):E==g-1&&(O=r.path),void 0!==O&&this.validator(r,a-1,t,O)),E++,void 0===o&&E>=g){s=f[r.op].call(r,y,o,t);break}if(c(y)){if("-"===o)o=y.length;else{if(n&&!i(o))throw new d("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",a-1,r.path,r);o=parseInt(o,10)}if(E>=g){if(n&&"add"===r.op&&o>y.length)throw new d("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",a-1,r.path,r);s=u[r.op].call(r,y,o,t);break}}else if(o&&-1!=o.indexOf("~")&&(o=o.replace(/~1/g,"/").replace(/~0/g,"~")),E>=g){s=l[r.op].call(r,y,o,t);break}if(!y){console.warning("slashes in object keys not supported");break}y=y[o]}}return s}function s(t){if(void 0===t)return!0;if("array"==typeof t||"object"==typeof t)for(var e in t)if(s(t[e]))return!0;return!1}function a(e,n,r,i){if("object"!=typeof e||null===e||c(e))throw new d("Operation is not an object","OPERATION_NOT_AN_OBJECT",n,e,r);if(!l[e.op])throw new d("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",n,e,r);if("string"!=typeof e.path)throw new d("Operation `path` property is not a string","OPERATION_PATH_INVALID",n,e,r);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new d("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",n,e,r);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new d("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",n,e,r);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&s(e.value))throw new d("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",n,e,r);if(r)if("add"==e.op){var o=e.path.split("/").length,a=i.split("/").length;if(o!==a+1&&o!==a)throw new d("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",n,e,r)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==i)throw new d("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",n,e,r)}else if("move"===e.op||"copy"===e.op){var h={op:"_get",path:e.from,value:void 0},p=t.validate([h],r);if(p&&"OPERATION_PATH_UNRESOLVABLE"===p.name)throw new d("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",n,e,r)}}function h(t,e){try{if(!c(t))throw new d("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)e=JSON.parse(JSON.stringify(e)),o.call(this,e,t,!0);else for(var n=0;n<t.length;n++)this.validator(t[n],n)}catch(r){if(r instanceof d)return r;throw r}}if(!t.apply){var c,p=function(){return Object.keys?Object.keys:function(t){var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(n);return e}}(),l={add:function(t,e){return t[e]=this.value,!0},remove:function(t,e){return delete t[e],!0},replace:function(t,e){return t[e]=this.value,!0},move:function(t,e,n){var r={op:"_get",path:this.from};return o(n,[r]),o(n,[{op:"remove",path:this.from}]),o(n,[{op:"add",path:this.path,value:r.value}]),!0},copy:function(t,e,n){var r={op:"_get",path:this.from};return o(n,[r]),o(n,[{op:"add",path:this.path,value:r.value}]),!0},test:function(t,e){return r(t[e],this.value)},_get:function(t,e){this.value=t[e]}},u={add:function(t,e){return t.splice(e,0,this.value),!0},remove:function(t,e){return t.splice(e,1),!0},replace:function(t,e){return t[e]=this.value,!0},move:l.move,copy:l.copy,test:l.test,_get:l._get},f={add:function(t){f.remove.call(this,t);for(var e in this.value)this.value.hasOwnProperty(e)&&(t[e]=this.value[e]);return!0},remove:function(t){for(var e in t)t.hasOwnProperty(e)&&l.remove.call(this,t,e);return!0},replace:function(t){return o(t,[{op:"remove",path:this.path}]),o(t,[{op:"add",path:this.path,value:this.value}]),!0},move:l.move,copy:l.copy,test:function(t){return JSON.stringify(t)===JSON.stringify(this.value)},_get:function(t){this.value=t}};c=Array.isArray?Array.isArray:function(t){return t.push&&"number"==typeof t.length},t.apply=o;var d=function(t){function n(e,n,r,i,o){t.call(this,e),this.message=e,this.name=n,this.index=r,this.operation=i,this.tree=o}return e(n,t),n}(n);t.JsonPatchError=d,t.Error=d,t.validator=a,t.validate=h}}(t||(t={})),"undefined"!=typeof exports&&(exports.apply=t.apply,exports.validate=t.validate,exports.validator=t.validator,exports.JsonPatchError=t.JsonPatchError,exports.Error=t.Error),function(e,n){function r(t){h.online=navigator.onLine;for(var e=0;e<s.length;e++)h.online&&s[e].retrying&&s[e].retry()}function i(t,n,r){switch(t){case h.WS:if(!e.WebSocket)throw"This browser does not support WebSockets";this.ws=!0;break;case h.SSE:this.sse=!0;break;default:throw"Type must be velox.WS or velox.SSE"}if(n||(n="/velox"),/^(ws|http)s?:/.test(n)||(n=l.protocol+"//"+l.host+n),this.ws&&(n=n.replace(/^http/,"ws")),this.url=n,!r||"object"!=typeof r)throw"Invalid object";this.obj=r,this.id="",this.version=0,this.onupdate=function(){},this.onerror=function(){},this.onconnect=function(){},this.ondisconnect=function(){},this.onchange=function(){},this.connected=!1,this.connect()}var o="v2",s=[],a=function(t,e,n){var r=new i(t,e,n);return s.push(r),r},h=function(t,n){return e.WebSocket?h.ws(t,n):h.sse(t,n)};h.WS={},h.ws=function(t,e){return a(h.WS,t,e)},h.SSE={},h.sse=function(t,e){return a(h.SSE,t,e)},h.proto=o,h.online=!0;var c=function(t,e){if(!t||"object"!=typeof t||!e||"object"!=typeof e)return e;var n;if(t instanceof Array&&e instanceof Array)for(;t.length>e.length;)t.pop();else for(n in t)"$"===n[0]||n in e||delete t[n];for(n in e)t[n]=c(t[n],e[n]);return t};e.addEventListener("online",r),e.addEventListener("offline",r);var p=["message","error","open","close"],l=e.location;i.prototype={connect:function(){this.retrying=!0,this.retry()},retry:function(){if(clearTimeout(this.retry.t),this.conn&&this.cleanup(),this.retrying){this.delay||(this.delay=100);var t=this.url,e=[];this.version&&e.push("v="+this.version),this.id&&e.push("id="+this.id),e.length&&(t+=(/\?/.test(this.url)?"&":"?")+e.join("&")),this.ws?this.conn=new WebSocket(t):this.conn=new EventSource(t,{withCredentials:!0});var n=this;p.forEach(function(t){n.conn["on"+t]=n["conn"+t].bind(n)}),this.pingout.t=setInterval(this.pingout.bind(this),3e4),this.sleepCheck.last=null,this.sleepCheck()}},disconnect:function(){this.retrying=!1,this.cleanup()},cleanup:function(){if(clearTimeout(this.pingout.t),this.conn){var t=this.conn;this.conn=null,p.forEach(function(e){t["on"+e]=null}),(t&&t instanceof EventSource&&t.readyState!==EventSource.CLOSED||t instanceof WebSocket&&t.readyState!==WebSocket.CLOSED)&&t.close(),this.statusCheck()}},send:function(t){return this.conn&&this.conn instanceof WebSocket&&this.conn.readyState===WebSocket.OPEN?this.conn.send(t):void 0},pingout:function(){this.send("ping")},pingin:function(){clearTimeout(this.pingin.t),this.pingin.t=setTimeout(this.retry.bind(this),3e4)},sleepCheck:function(){var t=this.sleepCheck;clearInterval(t.t);var e=Date.now(),n=t.last&&e-t.last>3e4;t.last=e,t.t=setTimeout(this.sleepCheck.bind(this),5e3),n&&this.retry()},statusCheck:function(t){var e=!!this.connected,n=void 0,r=this.conn;n=r&&r instanceof EventSource&&r.readyState===EventSource.OPEN||r instanceof WebSocket&&r.readyState===WebSocket.OPEN?!0:!1,e!==n&&(this.connected=n,this.onchange(this.connected),this.connected?this.onconnect():this.ondisconnect())},connmessage:function(e){var n;try{n=JSON.parse(e.data)}catch(r){return void this.onerror(r)}return n.ping?void this.pingin():(n.id&&(this.id=n.id),n.body&&this.obj?(n.delta?t.apply(this.obj,n.body):c(this.obj,n.body),"function"==typeof this.obj.$apply&&this.obj.$apply(),this.onupdate(this.obj),this.version=n.version,void(this.delay=100)):void this.onerror("null objects"))},connopen:function(){this.statusCheck(),this.pingin()},connclose:function(){this.statusCheck(),this.delay*=2,this.retrying&&h.online&&(this.retry.t=setTimeout(this.connect.bind(this),this.delay))},connerror:function(t){this.statusCheck(),this.onerror(t)}},e.velox=h}(window,document,void 0)}();
