// velox - v0.2.0 - https://github.com/jpillora/velox
// Jaime Pillora <dev@jpillora.com> - MIT Copyright 2016
var __extends,OriginalError,jsonpatch;!function(t,e){function n(t){a.online=navigator.onLine;for(var e=0;e<i.length;e++)a.online&&i[e].autoretry&&i[e].retry()}function r(t,e,n){switch(t){case a.WS:this.ws=!0;break;case a.SSE:this.sse=!0;break;default:throw"Type must be velox.WS or velox.SSE"}if(e||(e="/velox"),/^(ws|http)s?:/.test(e)||(e=c.protocol+"//"+c.host+e),this.ws&&(e=e.replace(/^http/,"ws")),this.url=e,!n||"object"!=typeof n)throw"Invalid object";this.obj=n,this.version=0,this.onupdate=function(){},this.onerror=function(){},this.connected=!1,this.connect()}var o,i,a,s,h,c;return t.WebSocket?(o="v2",i=[],a=function(t,e,n){var o=new r(t,e,n);return i.push(o),o},a.WS={},a.ws=function(t,e){return a(a.WS,t,e)},a.SSE={},a.sse=function(t,e){return a(a.SSE,t,e)},a.proto=o,a.online=!0,s=function(t,e){if(!t||"object"!=typeof t||!e||"object"!=typeof e)return e;var n;if(t instanceof Array&&e instanceof Array)for(;t.length>e.length;)t.pop();else for(n in t)"$"===n[0]||n in e||delete t[n];for(n in e)t[n]=s(t[n],e[n]);return t},t.addEventListener("online",n),t.addEventListener("offline",n),h=["message","error","open","close"],c=t.location,r.prototype={connect:function(){this.autoretry=!0,this.retry()},retry:function(){var t,e;clearTimeout(this.retry.t),this.conn&&this.cleanup(),this.delay||(this.delay=100),t=this.url+(/\?/.test(this.url)?"&":"?")+"p="+o+"&v="+this.version,this.ws?this.conn=new WebSocket(t):this.conn=new EventSource(t,{withCredentials:!0}),e=this,h.forEach(function(t){e.conn["on"+t]=e["conn"+t].bind(e)}),this.ping.t=setInterval(this.ping.bind(this),3e4)},disconnect:function(){this.autoretry=!1,this.cleanup()},cleanup:function(){if(this.conn){var t=this;h.forEach(function(e){t.conn["on"+e]=null}),(this.conn&&this.conn instanceof EventSource&&this.conn.readyState!==EventSource.CLOSED||this.conn instanceof WebSocket&&this.conn.readyState!==WebSocket.CLOSED)&&this.conn.close(),this.conn=null,clearTimeout(this.ping.t)}},send:function(t){return this.conn&&this.conn instanceof WebSocket&&this.conn.readyState===WebSocket.OPEN?this.conn.send(t):void 0},ping:function(){this.send("ping")},connmessage:function(t){var e,n=t.data;if("ping"!==n){try{e=JSON.parse(n)}catch(r){return void this.onerror(r)}if(!e.body||!this.obj)return void this.onerror("null objects");e.delta?jsonpatch.apply(this.obj,e.body):s(this.obj,e.body),"function"==typeof this.obj.$apply&&this.obj.$apply(),"function"==typeof this.onupdate&&this.onupdate(),this.version=e.version,this.delay=100}},connopen:function(){this.connected=!0},connclose:function(){this.connected=!1,this.delay*=2,this.autoretry&&a.online&&(this.retry.t=setTimeout(this.connect.bind(this),this.delay))},connerror:function(t){}},void(t.velox=a)):alert("This browser does not support WebSockets")}(window,document,void 0),function(t){var e,n,r;"EventSource"in t||(e=/^(\s|\u00A0)+|(\s|\u00A0)+$/g,n=function(t){function n(t){i._pollTimer=setTimeout(function(){o.call(i)},t)}function o(){try{if(i.readyState==i.CLOSED)return;var t=new XMLHttpRequest;t.open("GET",i.URL,!0),t.setRequestHeader("Accept","text/event-stream"),t.setRequestHeader("Cache-Control","no-cache"),t.setRequestHeader("X-Requested-With","XMLHttpRequest"),null!=s&&t.setRequestHeader("Last-Event-ID",s),h="",t.timeout=5e4,t.onreadystatechange=function(){var t,o,c,p,l,u,f;if(3==this.readyState||4==this.readyState&&200==this.status){i.readyState==i.CONNECTING&&(i.readyState=i.OPEN,i.dispatchEvent("open",{type:"open"})),t="";try{t=this.responseText||""}catch(d){}for(o=t.substr(h.length).split("\n"),c="message",p=[],l=0,u="",h=t;l<o.length;l++)u=o[l].replace(e,""),0==u.indexOf("event")?c=u.replace(/event:?\s*/,""):0==u.indexOf("retry")?(retry=parseInt(u.replace(/retry:?\s*/,"")),isNaN(retry)||(a=retry)):0==u.indexOf("data")?p.push(u.replace(/data:?\s*/,"")):0==u.indexOf("id:")?s=u.replace(/id:?\s*/,""):0==u.indexOf("id")?s=null:""==u&&p.length&&(f=new r(p.join("\n"),i.url,s),i.dispatchEvent(c,f),p=[],c="message");4==this.readyState&&n(a)}else i.readyState!==i.CLOSED&&(4==this.readyState?(i.readyState=i.CONNECTING,i.dispatchEvent("error",{type:"error"}),n(a)):0==this.readyState&&n(a))},t.send(),setTimeout(function(){t.abort()},t.timeout),i._xhr=t}catch(o){i.dispatchEvent("error",{type:"error",data:o.message})}}var i=this,a=500,s=null,h="";if(!t||"string"!=typeof t)throw new SyntaxError("Not enough arguments");this.URL=t,this.readyState=this.CONNECTING,this._pollTimer=null,this._xhr=null,o()},n.prototype={close:function(){this.readyState=this.CLOSED,clearInterval(this._pollTimer),this._xhr.abort()},CONNECTING:0,OPEN:1,CLOSED:2,dispatchEvent:function(t,e){var n,r=this["_"+t+"Handlers"];if(r)for(n=0;n<r.length;n++)r[n].call(this,e);this["on"+t]&&this["on"+t].call(this,e)},addEventListener:function(t,e){this["_"+t+"Handlers"]||(this["_"+t+"Handlers"]=[]),this["_"+t+"Handlers"].push(e)},removeEventListener:function(t,e){var n,r=this["_"+t+"Handlers"];if(r)for(n=r.length-1;n>=0;--n)if(r[n]===e){r.splice(n,1);break}},onerror:null,onmessage:null,onopen:null,readyState:0,URL:""},r=function(t,e,n){this.data=t,this.origin=e,this.lastEventId=n||""},r.prototype={data:null,type:"message",lastEventId:"",origin:""},"module"in t&&(module.exports=n),t.EventSource=n)}(this),__extends=this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);n.prototype=e.prototype,t.prototype=new n},OriginalError=Error,function(t){function e(t,n){var r,o,i,a;switch(typeof t){case"undefined":case"boolean":case"string":case"number":return t===n;case"object":if(null===t)return null===n;if(l(t)){if(!l(n)||t.length!==n.length)return!1;for(r=0,o=t.length;o>r;r++)if(!e(t[r],n[r]))return!1;return!0}if(i=s(n),a=i.length,s(t).length!==a)return!1;for(r=0;a>r;r++)if(!e(t[r],n[r]))return!1;return!0;default:return!1}}function n(t){for(var e,n=0,r=t.length;r>n;){e=t.charCodeAt(n);{if(!(e>=48&&57>=e))return!1;n++}}return!0}function r(t,e,r){for(var o,i,a,s,f,d,v,y,E=!1,O=0,g=e.length;g>O;)for(o=e[O],O++,a=o.path||"",s=a.split("/"),f=t,d=1,v=s.length,y=void 0;;){if(i=s[d],r&&void 0===y&&(void 0===f[i]?y=s.slice(0,d).join("/"):d==v-1&&(y=o.path),void 0!==y&&this.validator(o,O-1,t,y)),d++,void 0===i&&d>=v){E=p[o.op].call(o,f,i,t);break}if(l(f)){if("-"===i)i=f.length;else{if(r&&!n(i))throw new u("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",O-1,o.path,o);i=parseInt(i,10)}if(d>=v){if(r&&"add"===o.op&&i>f.length)throw new u("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",O-1,o.path,o);E=c[o.op].call(o,f,i,t);break}}else if(i&&-1!=i.indexOf("~")&&(i=i.replace(/~1/g,"/").replace(/~0/g,"~")),d>=v){E=h[o.op].call(o,f,i,t);break}if(!f){console.warning("slashes in object keys not supported");break}f=f[i]}return E}function o(t){if(void 0===t)return!0;if("array"==typeof t||"object"==typeof t)for(var e in t)if(o(t[e]))return!0;return!1}function i(e,n,r,i){var a,s,c,p;if("object"!=typeof e||null===e||l(e))throw new u("Operation is not an object","OPERATION_NOT_AN_OBJECT",n,e,r);if(!h[e.op])throw new u("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",n,e,r);if("string"!=typeof e.path)throw new u("Operation `path` property is not a string","OPERATION_PATH_INVALID",n,e,r);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new u("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",n,e,r);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new u("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",n,e,r);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&o(e.value))throw new u("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",n,e,r);if(r)if("add"==e.op){if(a=e.path.split("/").length,s=i.split("/").length,a!==s+1&&a!==s)throw new u("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",n,e,r)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==i)throw new u("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",n,e,r)}else if(("move"===e.op||"copy"===e.op)&&(c={op:"_get",path:e.from,value:void 0},p=t.validate([c],r),p&&"OPERATION_PATH_UNRESOLVABLE"===p.name))throw new u("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",n,e,r)}function a(t,e){try{if(!l(t))throw new u("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)e=JSON.parse(JSON.stringify(e)),r.call(this,e,t,!0);else for(var n=0;n<t.length;n++)this.validator(t[n],n)}catch(o){if(o instanceof u)return o;throw o}}var s,h,c,p,l,u;t.apply||(s=function(){return Object.keys?Object.keys:function(t){var e,n=[];for(e in t)t.hasOwnProperty(e)&&n.push(e);return n}}(),h={add:function(t,e){return t[e]=this.value,!0},remove:function(t,e){return delete t[e],!0},replace:function(t,e){return t[e]=this.value,!0},move:function(t,e,n){var o={op:"_get",path:this.from};return r(n,[o]),r(n,[{op:"remove",path:this.from}]),r(n,[{op:"add",path:this.path,value:o.value}]),!0},copy:function(t,e,n){var o={op:"_get",path:this.from};return r(n,[o]),r(n,[{op:"add",path:this.path,value:o.value}]),!0},test:function(t,n){return e(t[n],this.value)},_get:function(t,e){this.value=t[e]}},c={add:function(t,e){return t.splice(e,0,this.value),!0},remove:function(t,e){return t.splice(e,1),!0},replace:function(t,e){return t[e]=this.value,!0},move:h.move,copy:h.copy,test:h.test,_get:h._get},p={add:function(t){p.remove.call(this,t);for(var e in this.value)this.value.hasOwnProperty(e)&&(t[e]=this.value[e]);return!0},remove:function(t){for(var e in t)t.hasOwnProperty(e)&&h.remove.call(this,t,e);return!0},replace:function(t){return r(t,[{op:"remove",path:this.path}]),r(t,[{op:"add",path:this.path,value:this.value}]),!0},move:h.move,copy:h.copy,test:function(t){return JSON.stringify(t)===JSON.stringify(this.value)},_get:function(t){this.value=t}},l=Array.isArray?Array.isArray:function(t){return t.push&&"number"==typeof t.length},t.apply=r,u=function(t){function e(e,n,r,o,i){t.call(this,e),this.message=e,this.name=n,this.index=r,this.operation=o,this.tree=i}return __extends(e,t),e}(OriginalError),t.JsonPatchError=u,t.Error=u,t.validator=i,t.validate=a)}(jsonpatch||(jsonpatch={})),"undefined"!=typeof exports&&(exports.apply=jsonpatch.apply,exports.validate=jsonpatch.validate,exports.validator=jsonpatch.validator,exports.JsonPatchError=jsonpatch.JsonPatchError,exports.Error=jsonpatch.Error);
