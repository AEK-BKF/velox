// velox - v0.2.0 - https://github.com/jpillora/velox
// Jaime Pillora <dev@jpillora.com> - MIT Copyright 2016
!function(t,e){function n(t){r.online=navigator.onLine;for(var e=0;e<s.length;e++)r.online&&s[e].autoretry&&s[e].retry()}function i(t,e,n){switch(t){case r.WS:this.ws=!0;break;case r.SSE:this.sse=!0;break;default:throw"Type must be velox.WS or velox.SSE"}if(e||(e="/velox"),/^(ws|http)s?:/.test(e)||(e=h.protocol+"//"+h.host+e),this.ws&&(e=e.replace(/^http/,"ws")),this.url=e,!n||"object"!=typeof n)throw"Invalid object";this.obj=n,this.version=0,this.onupdate=function(){},this.onerror=function(){},this.connected=!1,this.connect()}var o,s,r,a,c,h;return t.WebSocket?(o="v2",s=[],r=function(t,e,n){var o=new i(t,e,n);return s.push(o),o},r.WS={},r.ws=function(t,e){return r(r.WS,t,e)},r.SSE={},r.sse=function(t,e){return r(r.SSE,t,e)},r.proto=o,r.online=!0,a=function(t,e){if(!t||"object"!=typeof t||!e||"object"!=typeof e)return e;var n;if(t instanceof Array&&e instanceof Array)for(;t.length>e.length;)t.pop();else for(n in t)"$"===n[0]||n in e||delete t[n];for(n in e)t[n]=a(t[n],e[n]);return t},t.addEventListener("online",n),t.addEventListener("offline",n),c=["message","error","open","close"],h=t.location,i.prototype={connect:function(){this.autoretry=!0,this.retry()},retry:function(){var t,e;clearTimeout(this.retry.t),this.conn&&this.cleanup(),this.delay||(this.delay=100),t=this.url+(/\?/.test(this.url)?"&":"?")+"p="+o+"&v="+this.version,this.ws?this.conn=new WebSocket(t):this.conn=new EventSource(t,{withCredentials:!0}),e=this,c.forEach(function(t){e.conn["on"+t]=e["conn"+t].bind(e)}),this.ping.t=setInterval(this.ping.bind(this),3e4)},disconnect:function(){this.autoretry=!1,this.cleanup()},cleanup:function(){if(this.conn){var t=this;c.forEach(function(e){t.conn["on"+e]=null}),(this.conn&&this.conn instanceof EventSource&&this.conn.readyState!==EventSource.CLOSED||this.conn instanceof WebSocket&&this.conn.readyState!==WebSocket.CLOSED)&&this.conn.close(),this.conn=null,clearTimeout(this.ping.t)}},send:function(t){return this.conn&&this.conn instanceof WebSocket&&this.conn.readyState===WebSocket.OPEN?this.conn.send(t):void 0},ping:function(){this.send("ping")},connmessage:function(t){var e,n=t.data;if("ping"!==n){try{e=JSON.parse(n)}catch(i){return void this.onerror(i)}if(!e.body||!this.obj)return void this.onerror("null objects");e.delta?jsonpatch.apply(this.obj,e.body):a(this.obj,e.body),"function"==typeof this.obj.$apply&&this.obj.$apply(),"function"==typeof this.onupdate&&this.onupdate(),this.version=e.version,this.delay=100}},connopen:function(){this.connected=!0},connclose:function(){this.connected=!1,this.delay*=2,this.autoretry&&r.online&&(this.retry.t=setTimeout(this.connect.bind(this),this.delay))},connerror:function(t){}},void(t.velox=r)):alert("This browser does not support WebSockets")}(window,document,void 0),function(t){var e,n,i;"EventSource"in t||(e=/^(\s|\u00A0)+|(\s|\u00A0)+$/g,n=function(t){function n(t){s._pollTimer=setTimeout(function(){o.call(s)},t)}function o(){try{if(s.readyState==s.CLOSED)return;var t=new XMLHttpRequest;t.open("GET",s.URL,!0),t.setRequestHeader("Accept","text/event-stream"),t.setRequestHeader("Cache-Control","no-cache"),t.setRequestHeader("X-Requested-With","XMLHttpRequest"),null!=a&&t.setRequestHeader("Last-Event-ID",a),c="",t.timeout=5e4,t.onreadystatechange=function(){var t,o,h,l,u,d,p;if(3==this.readyState||4==this.readyState&&200==this.status){s.readyState==s.CONNECTING&&(s.readyState=s.OPEN,s.dispatchEvent("open",{type:"open"})),t="";try{t=this.responseText||""}catch(f){}for(o=t.substr(c.length).split("\n"),h="message",l=[],u=0,d="",c=t;u<o.length;u++)d=o[u].replace(e,""),0==d.indexOf("event")?h=d.replace(/event:?\s*/,""):0==d.indexOf("retry")?(retry=parseInt(d.replace(/retry:?\s*/,"")),isNaN(retry)||(r=retry)):0==d.indexOf("data")?l.push(d.replace(/data:?\s*/,"")):0==d.indexOf("id:")?a=d.replace(/id:?\s*/,""):0==d.indexOf("id")?a=null:""==d&&l.length&&(p=new i(l.join("\n"),s.url,a),s.dispatchEvent(h,p),l=[],h="message");4==this.readyState&&n(r)}else s.readyState!==s.CLOSED&&(4==this.readyState?(s.readyState=s.CONNECTING,s.dispatchEvent("error",{type:"error"}),n(r)):0==this.readyState&&n(r))},t.send(),setTimeout(function(){t.abort()},t.timeout),s._xhr=t}catch(o){s.dispatchEvent("error",{type:"error",data:o.message})}}var s=this,r=500,a=null,c="";if(!t||"string"!=typeof t)throw new SyntaxError("Not enough arguments");this.URL=t,this.readyState=this.CONNECTING,this._pollTimer=null,this._xhr=null,o()},n.prototype={close:function(){this.readyState=this.CLOSED,clearInterval(this._pollTimer),this._xhr.abort()},CONNECTING:0,OPEN:1,CLOSED:2,dispatchEvent:function(t,e){var n,i=this["_"+t+"Handlers"];if(i)for(n=0;n<i.length;n++)i[n].call(this,e);this["on"+t]&&this["on"+t].call(this,e)},addEventListener:function(t,e){this["_"+t+"Handlers"]||(this["_"+t+"Handlers"]=[]),this["_"+t+"Handlers"].push(e)},removeEventListener:function(t,e){var n,i=this["_"+t+"Handlers"];if(i)for(n=i.length-1;n>=0;--n)if(i[n]===e){i.splice(n,1);break}},onerror:null,onmessage:null,onopen:null,readyState:0,URL:""},i=function(t,e,n){this.data=t,this.origin=e,this.lastEventId=n||""},i.prototype={data:null,type:"message",lastEventId:"",origin:""},"module"in t&&(module.exports=n),t.EventSource=n)}(this);
